name: Run AlgoPari

on:
  schedule:
    - cron: "0 7 * * *"   # tous les jours à 07:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ▶️ Run main.py
        run: |
          python main.py

      - name: 📂 Show generated files (debug)
        run: |
          echo "---- results ----"
          ls -la results || echo "No results directory"
          echo "---- logs ----"
          ls -la logs || echo "No logs directory"
          echo "---- data ----"
          ls -la data || echo "No data directory"

      - name: 📤 Commit & push results if changed
        run: |
          # configure an identity for commits
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Stage files (add pending_matches in case it exists)
          git add results/ logs/ data/pending_matches.csv || true

          # Commit only if there are staged changes
          if ! git diff --staged --quiet; then
            git commit -m "Mise à jour résultats et logs [skip ci]" || true
            git push
          else
            echo "Aucun changement à committer."
          fi
